- hosts: localhost
  roles:
    - name: trombik.apt_repo
      when: ansible_os_family == 'Debian'
    - ansible-role-grafana
  vars:
    apt_repo_keys_to_add:
      - https://packagecloud.io/gpg.key
    apt_repo_enable_apt_transport_https: yes
    apt_repo_to_add:
      # https://packagecloud.io/install/repositories/grafana/stable/config_file.list?os=ubuntu&dist=bionic&source=script
      # XXX use `stretch` here because the repository does not support Ubuntu
      # code name.
      - "deb https://packagecloud.io/grafana/stable/{{ ansible_os_family | lower }}/ stretch main"
    grafana_extra_packages:
      - name: zsh
    flags:
      FreeBSD: |
        grafana_conf="{{ grafana_conf_file }}"

    grafana_flags: "{{ flags[ansible_os_family] }}"
    grafana_config: |
      [paths]
      data = {{ grafana_db_dir }}
      logs = {{ grafana_log_dir }}
      plugins = /var/db/grafana/plugins
      provisioning = {{ grafana_provisioning_dir }}
      [server]
      [database]
      log_queries =
      [session]
      [dataproxy]
      [analytics]
      [security]
      [snapshots]
      [dashboards]
      [users]
      [auth]
      [auth.anonymous]
      [auth.github]
      [auth.google]
      [auth.generic_oauth]
      [auth.grafana_com]
      [auth.proxy]
      [auth.basic]
      [auth.ldap]
      [smtp]
      [emails]
      [log]
      [log.console]
      [log.file]
      [log.syslog]
      [alerting]
      [metrics]
      [metrics.graphite]
      [tracing.jaeger]
      [grafana_com]
      [external_image_storage]
      [external_image_storage.s3]
      [external_image_storage.webdav]
      [external_image_storage.gcs]
      [external_image_storage.azure_blob]
      [external_image_storage.local]
